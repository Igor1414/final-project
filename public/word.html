<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Word</title>
  
  <!-- Bootstrap -->
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
    rel="stylesheet"
  >
</head>
<body>
    <!-- Верхний navbar -->
  <nav class="navbar navbar-expand-lg bg-white fixed-top shadow-sm">
    <div class="container-fluid px-4">
      <h3>English–Japanese Dictionary</h3>
      <p id="user"></p>

      <button onclick="goProfile()">Profile</button>
      <button onclick="logout()">Logout</button>

      </div>
  </nav>
  <h1>Word details</h1>

  <p id="status"></p>

  <label>
    English:
    <input id="english" />
  </label><br><br>

  <label>
    Japanese:
    <input id="japanese" />
  </label><br><br>

  <label>
    Reading:
    <input id="reading" />
  </label><br><br>

  <label>
    Meaning:
    <input id="meaning" />
  </label><br><br>

  <p id="author"></p>

  <button id="saveBtn" onclick="updateWord()">Save</button>
  <button id="deleteBtn" onclick="deleteWord()">Delete</button>
  <button onclick="goBack()">Back</button>

  <script>
    const params = new URLSearchParams(window.location.search);
    const wordId = params.get('id');
    const token = localStorage.getItem('token');

    if (!wordId) {
      document.getElementById('status').innerText = 'No word id';
    }

    async function loadWord() {
      const res = await fetch(`/api/words/${wordId}`);
      const word = await res.json();

      if (!res.ok) {
        document.getElementById('status').innerText = word.message;
        return;
      }

      document.getElementById('english').value = word.english;
      document.getElementById('japanese').value = word.japanese;
      document.getElementById('reading').value = word.reading || '';
      document.getElementById('meaning').value = word.meaning;
      document.getElementById('author').innerText =
        `Added by: ${word.createdBy.username}`;

      checkOwnership(word.createdBy._id);
    }

    async function checkOwnership(ownerId) {
      if (!token) {
        disableEdit();
        return;
      }

      const res = await fetch('/api/users/profile', {
        headers: { Authorization: 'Bearer ' + token }
      });

      if (!res.ok) {
        disableEdit();
        return;
      }

      const user = await res.json();

      if (user._id !== ownerId) {
        disableEdit();
      }
    }

    function disableEdit() {
      document.getElementById('saveBtn').style.display = 'none';
      document.getElementById('deleteBtn').style.display = 'none';
    }

    async function updateWord() {
      const body = {
        english: english.value,
        japanese: japanese.value,
        reading: reading.value,
        meaning: meaning.value
      };

      const res = await fetch(`/api/words/${wordId}`, {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json',
          Authorization: 'Bearer ' + token
        },
        body: JSON.stringify(body)
      });

      const data = await res.json();

      if (res.ok) {
        document.getElementById('status').innerText = '✅ Updated';
      } else {
        document.getElementById('status').innerText = data.message;
      }
    }

    async function deleteWord() {
      if (!confirm('Delete this word?')) return;

      const res = await fetch(`/api/words/${wordId}`, {
        method: 'DELETE',
        headers: {
          Authorization: 'Bearer ' + token
        }
      });

      if (res.ok) {
        window.location.href = '/index.html';
      } else {
        const data = await res.json();
        document.getElementById('status').innerText = data.message;
      }
    }

    function goBack() {
      window.history.back();
    }

    loadWord();
  </script>
</body>
</html>
